{{- $serviceName := include "service.name" . -}}

{{- if .Values.externalSecrets.service.key }}
---
apiVersion: 'external-secrets.io/v1beta1'
kind: ExternalSecret
metadata:
  name: {{ $serviceName }}-service-secrets
  namespace: {{ .Release.Namespace }}
spec:
  secretStoreRef:
    kind: SecretStore
  {{- if .Values.externalSecrets.service.secretstoreName }}
    name: {{ .Values.externalSecrets.service.secretstoreName }}
  {{- else }}
    name: external-secret-store-{{ .Release.Namespace }}
  {{- end }}
  target:
    name: {{ $serviceName }}-service-secrets
  dataFrom:
  - extract:
      key: {{ .Values.externalSecrets.service.key }}
  {{- if .Values.externalSecrets.service.refreshInterval }}
  refreshInterval: {{ .Values.externalSecrets.service.refreshInterval }}
  {{- else }}
  refreshInterval: 15m
  {{- end }}
{{- end }}

{{- if and .Values.externalSecrets.oauth2.key .Values.gloo.authConfig.spec.configs.oauth.clientId }}
---
apiVersion: 'external-secrets.io/v1beta1'
kind: ExternalSecret
metadata:
  name: {{ $serviceName }}-oidc-secrets
  namespace: {{ .Release.Namespace }}
spec:
  secretStoreRef:
    kind: SecretStore
  {{- if .Values.externalSecrets.service.secretstoreName }}
    name: {{ .Values.externalSecrets.service.secretstoreName }}
  {{- else }}
    name: external-secret-store-{{ .Release.Namespace }}
  {{- end }}
  target:
    name: {{ $serviceName }}-oidc-secrets
    template:
      metadata:
        annotations:
          resource_kind: '*v1.Secret'
  data:
    - secretKey: oauth
      remoteRef:
        key: {{ .Values.externalSecrets.oauth2.key }}
        property: {{ .Values.gloo.authConfig.spec.configs.oauth.clientId | quote }}
  {{- if .Values.externalSecrets.service.refreshInterval }}
  refreshInterval: {{ .Values.externalSecrets.service.refreshInterval }}
  {{- else }}
  refreshInterval: 15m
  {{- end }}

{{- end }}

{{- if and .Values.externalSecrets.oauth2.key .Values.gloo.authConfig.spec.configs.clientCredentialsPlugin.config.clientId }}
---
apiVersion: 'external-secrets.io/v1beta1'
kind: ExternalSecret
metadata:
  name: {{ $serviceName }}-oauth2-client-credentials-secrets
  namespace: {{ .Release.Namespace }}
spec:
  secretStoreRef:
    kind: SecretStore
  {{- if .Values.externalSecrets.service.secretstoreName }}
    name: {{ .Values.externalSecrets.service.secretstoreName }}
  {{- else }}
    name: external-secret-store-{{ .Release.Namespace }}
  {{- end }}
  target:
    name: {{ $serviceName }}-oauth2-client-credentials-secrets
  data:
    - secretKey: ClientCredentialsFlow
      remoteRef:
        key: {{ .Values.externalSecrets.oauth2.key }}
        property: {{ .Values.gloo.authConfig.spec.configs.clientCredentialsPlugin.config.clientId | quote }}
  {{- if .Values.externalSecrets.service.refreshInterval }}
  refreshInterval: {{ .Values.externalSecrets.service.refreshInterval }}
  {{- else }}
  refreshInterval: 15m
  {{- end }}

{{- end }}
